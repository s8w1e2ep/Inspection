var parkingBlockData={};var CART_WIDTH=12;var CART_HEIGHT=14;var PARKING_BLOCK_MARGIN=2;var CART_TIME_STATUS_COLOR_NORMAL="#b9cde5";var CART_TIME_STATUS_COLOR_HALF_OVERTIME="#ffff00";var CART_TIME_STATUS_COLOR_OVERTIME="#ff0000";var CART_TIME_STATUS_COLOR_LOW_POWER="#000000";var CART_TIME_STATUS_NORMAL=0;var CART_TIME_STATUS_HALF_OVERTIME=1;var CART_TIME_STATUS_OVERTIME=2;var CART_TIME_STATUS_LOW_POWER=3;var CART_STATUS_USED="USED";var CART_STATUS_IDLE="IDLE";var CART_STATUS_TERMINATED="TERMINATED";var CART_SCHEDULE_PERIOD="schedulePeriod";var CART_SCHEDULE_BEFORE="scheduleBefore";var CART_SCHEDULE_AFTER="scheduleAfter";var PARKINGBLOCK_HIGHTLIGHT="#FFFF00";var PARKINGBLOCK_UNHIGHTLIGHT="#4f81bd";var carrierLotData={};function moveCart(d,g,c,f,e){var a=findMainDisplayParkingBlock(g,c);if(a!=null){var b=d.substring(0,1);switch(b){case"D":case"W":case"T":case"Q":case"C":TweenMax.to("#cart_"+d,0.5,{attr:{x:parseInt(a.x),y:parseInt(a.y)},onComplete:function(){var h=$("#cart_"+d).data("bs.popover");h.options.content=f;$("#cart_"+d).popover("show");if(e!=undefined){e()}}});break;case"B":case"A":break}}else{if(e!=undefined){e()}}}function updateCartStatus(c,a){var b=c.substring(0,1);switch(b){case"D":case"W":case"T":case"Q":case"C":switch(a){case CART_TIME_STATUS_NORMAL:$("#cart_"+c).attr("fill",CART_TIME_STATUS_COLOR_NORMAL);break;case CART_TIME_STATUS_OVERTIME:$("#cart_"+c).attr("fill",CART_TIME_STATUS_COLOR_OVERTIME);break;case CART_TIME_STATUS_HALF_OVERTIME:$("#cart_"+c).attr("fill",CART_TIME_STATUS_COLOR_HALF_OVERTIME);break;case CART_TIME_STATUS_LOW_POWER:$("#cart_"+c).attr("fill",CART_TIME_STATUS_COLOR_LOW_POWER);break}break;case"B":case"A":switch(a){case CART_TIME_STATUS_NORMAL:$("#cartBackgroud_"+c).attr("fill",CART_TIME_STATUS_COLOR_NORMAL);break;case CART_TIME_STATUS_OVERTIME:$("#cartBackgroud_"+c).attr("fill",CART_TIME_STATUS_COLOR_OVERTIME);break;case CART_TIME_STATUS_HALF_OVERTIME:$("#cartBackgroud_"+c).attr("fill",CART_TIME_STATUS_COLOR_HALF_OVERTIME);break;case CART_TIME_STATUS_LOW_POWER:$("#cartBackgroud_"+c).attr("fill",CART_TIME_STATUS_COLOR_LOW_POWER);break}break}}function showLotData(c,a,b){$("#lotInfoPanel").removeClass("hide");var d=carrierLotData[c]["CarrierLotData"][a]["LotList"][b];$("#Lot").text(d.Lot);$("#DeviceDescr").text(d.DeviceDescr);$("#LastOutTime").text(d.LastOutTime);$("#OperationNo").text(d.OperationNo);$("#Quantity").text(d.Quantity);$("#WaitStatus").text(d.WaitStatus);$("#MaxWaitTimeHour").text(d.MaxWaitTimeHour);$("#WaitTime").text(d.WaitTime);$("#ColorName").text(d.ColorName);$("#CustomerName").text(d.CustomerName);$("#Factory").text(d.Factory);$("#ScheduleDate").text(d.ScheduleDate);$("#SalesAssistant").text(d.SalesAssistant)}function closePopover(a){$(a).popover("hide")}function drawPopover(b,a,c){$(b).popover({trigger:"manual",html:true,title:'<button class="btn pull-right" onclick="closePopover(\''+b+'\')"><i class="fa fa-close"></i></button><h4>載具編號：'+a+"</h4><br>批號明細",content:'<div class="container">'+c+"</div>",container:"body",animation:false}).on("mouseenter",function(){var d=this;$(this).popover("show");$(".popover").on("mouseleave",function(){$(d).popover("hide")})}).on("mouseleave",function(){var d=this;setTimeout(function(){if(!$(".popover:hover").length){$(d).popover("hide")}},300)})}function clearPopover(){var a=$(".popover");$.each(a,function(b,c){$(c).popover("hide")})}function drawDWTTypeCart(b,c,e,a,f){var d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttributeNS(null,"id","cart_"+e);d.setAttributeNS(null,"width","8");d.setAttributeNS(null,"height","10");d.setAttributeNS(null,"x",a);d.setAttributeNS(null,"y",f);d.setAttributeNS(null,"rx",2);d.setAttributeNS(null,"ry",2);d.setAttributeNS(null,"fill",CART_TIME_STATUS_COLOR_NORMAL);d.setAttributeNS(null,"stroke","#0000ff");d.setAttributeNS(null,"stroke-width",2);$("#"+b+"_svg .svg-pan-zoom_viewport "+c).append(d)}function drawQTypeCart(b,c,d,a,f){var e=document.createElementNS("http://www.w3.org/2000/svg","circle");e.setAttributeNS(null,"id","cart_"+d);e.setAttributeNS(null,"cx",a+4);e.setAttributeNS(null,"cy",f+5);e.setAttributeNS(null,"r",4);e.setAttributeNS(null,"fill",CART_TIME_STATUS_COLOR_NORMAL);e.setAttributeNS(null,"stroke","#0000ff");e.setAttributeNS(null,"stroke-width",2);$("#"+b+"_svg .svg-pan-zoom_viewport "+c).append(e)}function drawBigATypeCart(e,a,c,i,f){var d=document.createElementNS("http://www.w3.org/2000/svg","g");d.setAttributeNS(null,"id","#cart_"+c+"_g");$("#"+e+"_svg .svg-pan-zoom_viewport "+a).append(d);var h=document.createElementNS("http://www.w3.org/2000/svg","rect");h.setAttributeNS(null,"id","cartBackgroud_"+c);h.setAttributeNS(null,"width","10");h.setAttributeNS(null,"height","12");h.setAttributeNS(null,"x",i-1);h.setAttributeNS(null,"y",f-1);h.setAttributeNS(null,"rx",2);h.setAttributeNS(null,"ry",2);h.setAttributeNS(null,"fill",CART_TIME_STATUS_COLOR_NORMAL);$(d).append(h);var j=document.createElementNS("http://www.w3.org/2000/svg","text");j.setAttributeNS(null,"id","cart_"+c);j.setAttributeNS(null,"x",i);j.setAttributeNS(null,"y",f+10);j.setAttributeNS(null,"fill","#00b050");j.setAttributeNS(null,"stroke","#00b050");j.setAttributeNS(null,"stroke-width",1);j.setAttributeNS(null,"cursor","default");var b=document.createTextNode("A");j.appendChild(b);$(d).append(j)}function drawSmallATypeCart(e,a,c,i,f){var d=document.createElementNS("http://www.w3.org/2000/svg","g");d.setAttributeNS(null,"id","#cart_"+c+"_g");$("#"+e+"_svg .svg-pan-zoom_viewport "+a).append(d);var h=document.createElementNS("http://www.w3.org/2000/svg","rect");h.setAttributeNS(null,"id","cartBackgroud_"+c);h.setAttributeNS(null,"width","10");h.setAttributeNS(null,"height","12");h.setAttributeNS(null,"x",i-1);h.setAttributeNS(null,"y",f-1);h.setAttributeNS(null,"rx",2);h.setAttributeNS(null,"ry",2);h.setAttributeNS(null,"fill",CART_TIME_STATUS_COLOR_NORMAL);$(d).append(h);var j=document.createElementNS("http://www.w3.org/2000/svg","text");j.setAttributeNS(null,"id","cart_"+c);j.setAttributeNS(null,"x",i);j.setAttributeNS(null,"y",f+9);j.setAttributeNS(null,"fill","#00b050");j.setAttributeNS(null,"stroke","#00b050");j.setAttributeNS(null,"stroke-width",1);j.setAttributeNS(null,"cursor","default");var b=document.createTextNode("a");j.appendChild(b);$(d).append(j)}function drawCTypeCart(e,c,d,g,f){var b=0;var h=0;var i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"id","cart_"+d);b=g+2;var a="M "+b+" "+f;b=b+4;a=a+" L "+b+" "+f;b=b+2;h=f+10;a=a+" L "+b+" "+h;b=b-8;a=a+" L "+b+" "+h;a=a+" Z";i.setAttributeNS(null,"d",a);i.setAttributeNS(null,"fill",CART_TIME_STATUS_COLOR_NORMAL);i.setAttributeNS(null,"stroke","#00b050");i.setAttributeNS(null,"stroke-width",2);i.setAttributeNS(null,"stroke-linejoin","round");$("#"+e+"_svg .svg-pan-zoom_viewport "+c).append(i)}function setCartBlink(a){$("#cart_"+a).attr({"class":"blinkClass"})}function highlightParkingBlock(a){$("."+a).attr({fill:PARKINGBLOCK_HIGHTLIGHT});$("."+a+" text").css("display","")}function unhighlightParkingBlock(a){$("."+a).attr({fill:PARKINGBLOCK_UNHIGHTLIGHT});$("#parkingBlockText_"+a).css("display","none")}function findMainDisplayParkingBlock(c,b){var a=null;if(c in parkingBlockData){var e=parkingBlockData[c];console.log(e);if(b in e){var d=e[b];console.log(d);$.each(d,function(g,f){if(f.mainDisplay==1){a=f;if(!("cartCount" in a)){a.cartCount=0;return false}}});console.log(a);return a}}}function drawCart(g,j,a,e){var f=findMainDisplayParkingBlock(g,j);if(f!=null){var d=parseInt(f.x)+PARKING_BLOCK_MARGIN;var c=parseInt(f.y)+PARKING_BLOCK_MARGIN;var h=parseInt(parseInt(f.width)/CART_WIDTH);var m=parseInt(parseInt(f.cartCount)/h);var b=parseInt(f.cartCount)%h;var k,i;k=d+b*CART_WIDTH;i=c+m*CART_HEIGHT;var l=e.substring(0,1);switch(l){case"D":case"W":case"T":drawDWTTypeCart(g,a,e,k,i);break;case"Q":drawQTypeCart(g,a,e,k,i);break;case"B":drawBigATypeCart(g,a,e,k,i);break;case"A":drawSmallATypeCart(g,a,e,k,i);break;case"C":drawCTypeCart(g,a,e,k,i);break}f.cartCount=f.cartCount+1}}function addCartToParkingBlockWithScheduleDate(c,a,f,h,g,e){var d="";var b=CART_TIME_STATUS_NORMAL;$.post("http://172.16.3.180/EverestAPI04/Automation/GetCarrierDataAndLots",{Carrier:f},function(i){carrierLotData[f]=i;$.each(i.CarrierLotData,function(k,j){var l=false;$.each(j.LotList,function(n,o){var p=o.ScheduleDate;switch(h){case CART_SCHEDULE_PERIOD:if(p>=g&&p<=e){l=true}break;case CART_SCHEDULE_BEFORE:if(p<=g){l=true}break;case CART_SCHEDULE_AFTER:if(p>=g){l=true}break}var m=parseInt(o.WaitStatus);if(m>b){b=m}switch(m){case CART_TIME_STATUS_NORMAL:textColot=CART_TIME_STATUS_COLOR_NORMAL;break;case CART_TIME_STATUS_HALF_OVERTIME:textColot=CART_TIME_STATUS_COLOR_HALF_OVERTIME;break;case CART_TIME_STATUS_OVERTIME:textColot=CART_TIME_STATUS_COLOR_OVERTIME;break}if(d!=""){d=d+"<br>"}d=d+'<a id="'+o.Lot+'" style="color:'+textColot+';" href="#" onclick="showLotData(\''+f+"', "+k+", "+n+')">'+o.Lot+"</a>"});if(l){drawCart(c,a,"#cart_g",f);updateCartStatus(f,b);drawPopover("#cart_"+f,f,d)}})},"json").fail(function(){alert("讀取 MES 資料失敗");console.log("讀取 MES 資料失敗");drawCart(c,a,"#cart_g",f);drawPopover("#cart_"+f,f,d)})}function addCartToParkingBlockWithWaitStatus(c,a,e,f){var d="";var b=CART_TIME_STATUS_NORMAL;$.post("http://172.16.3.180/EverestAPI04/Automation/GetCarrierDataAndLots",{Carrier:e},function(g){carrierLotData[e]=g;$.each(g.CarrierLotData,function(i,h){$.each(h.LotList,function(k,l){var j=parseInt(l.WaitStatus);if(j>b){b=j}switch(j){case CART_TIME_STATUS_NORMAL:textColot=CART_TIME_STATUS_COLOR_NORMAL;break;case CART_TIME_STATUS_HALF_OVERTIME:textColot=CART_TIME_STATUS_COLOR_HALF_OVERTIME;break;case CART_TIME_STATUS_OVERTIME:textColot=CART_TIME_STATUS_COLOR_OVERTIME;break}if(d!=""){d=d+"<br>"}d=d+'<a id="'+l.Lot+'" style="color:'+textColot+';" href="#" onclick="showLotData(\''+e+"', "+i+", "+k+')">'+l.Lot+"</a>"});if(b>CART_TIME_STATUS_NORMAL&&(b&f)==b){drawCart(c,a,"#cart_g",e);updateCartStatus(e,b);drawPopover("#cart_"+e,e,d)}})},"json").fail(function(){alert("讀取 MES 資料失敗");drawCart(c,a,"#cart_g",e);drawPopover("#cart_"+e,e,d)})}function addCartToParkingBlock(c,a,f,g,h){var e="";var b=CART_TIME_STATUS_NORMAL;var d=CART_TIME_STATUS_COLOR_NORMAL;$.post("http://172.16.3.180/EverestAPI04/Automation/GetCarrierDataAndLots",{Carrier:f},function(i){if(g==""||g==i.CarrierLotData[0]["State"]){carrierLotData[f]=i;$.each(i.CarrierLotData,function(k,j){$.each(j.LotList,function(m,n){var l=parseInt(n.WaitStatus);if(l>b){b=l}switch(l){case CART_TIME_STATUS_NORMAL:d=CART_TIME_STATUS_COLOR_NORMAL;break;case CART_TIME_STATUS_HALF_OVERTIME:d=CART_TIME_STATUS_COLOR_HALF_OVERTIME;break;case CART_TIME_STATUS_OVERTIME:d=CART_TIME_STATUS_COLOR_OVERTIME;break}if(e!=""){e=e+"<br>"}e=e+'<a id="'+n.Lot+'" style="color:'+d+';" href="#" onclick="showLotData(\''+f+"', "+k+", "+m+')">'+n.Lot+"</a>"});if(h){drawCart(c,a,"#cart_g",f);setCartBlink(f)}else{drawCart(c,a,"#cart_g",f)}drawPopover("#cart_"+f,f,e);if(b>CART_TIME_STATUS_NORMAL){updateCartStatus(f,b)}})}},"json").fail(function(){alert("讀取 MES 資料失敗");drawCart(c,a,"#cart_g",f);drawPopover("#cart_"+f,f,e)})}function addCartToParkingBlockWithoutLotData(c,b,d,a){drawCart(c,b,"#select_cart_g",d);$("#cart_"+d).popover({content:"",container:"#mapTab"+a,animation:false})}function drawParkingBlock(a,f){var c=document.createElementNS("http://www.w3.org/2000/svg","g");c.setAttributeNS(null,"id",f.dataId+"_g");$("#"+a+"_svg #parkingBlock_g").append(c);var b=document.createElementNS("http://www.w3.org/2000/svg","rect");b.setAttributeNS(null,"id","parkingBlock_"+f.dataId);if(f.mainDisplay==1){b.setAttributeNS(null,"class",f.parkingBlockId+" mainDisplay")}else{b.setAttributeNS(null,"class",f.parkingBlockId)}b.setAttributeNS(null,"x",f.x);b.setAttributeNS(null,"y",f.y);b.setAttributeNS(null,"width",f.width);b.setAttributeNS(null,"height",f.height);b.setAttributeNS(null,"fill",PARKINGBLOCK_UNHIGHTLIGHT);b.setAttributeNS(null,"fill-opacity",0.5);$(c).append(b);var e=document.createElementNS("http://www.w3.org/2000/svg","text");e.setAttributeNS(null,"id","parkingBlockText_"+f.dataId);e.setAttributeNS(null,"x",f.x+f.width/2);e.setAttributeNS(null,"y",f.y+f.height/2);e.setAttributeNS(null,"alignment-baseline","middle");e.setAttributeNS(null,"text-anchor","middle");e.setAttributeNS(null,"stroke","red");e.setAttributeNS(null,"style","display:none");var d=document.createTextNode(f.dataId);e.appendChild(d);$(c).append(e)}function clearParkingBlock(a){$("#"+a+"_svg #cart_g").empty();$("#"+a+"_svg #select_cart_g").empty();if(a in parkingBlockData){var b=parkingBlockData[a];$.each(b,function(c,d){d.cartCount=0})}}function addParkingBlock(a,b){parkingBlockData[a]={};$.each(b,function(d,c){if(!(c.parkingBlockId in parkingBlockData[a])){parkingBlockData[a][c.parkingBlockId]={}}parkingBlockData[a][c.parkingBlockId][c.dataId]=c;drawParkingBlock(a,c)})}function showUnselectedCartLayer(a,b){if(b){$("#"+a+"_svg .svg-pan-zoom_viewport #cart_g").css("display","")}else{$("#"+a+"_svg .svg-pan-zoom_viewport #cart_g").css("display","none")}}function createMapLayer(a){var b=document.createElementNS("http://www.w3.org/2000/svg","g");b.setAttributeNS(null,"id","parkingBlock_g");$("#"+a+"_svg .svg-pan-zoom_viewport").append(b);b=document.createElementNS("http://www.w3.org/2000/svg","g");b.setAttributeNS(null,"id","cart_g");$("#"+a+"_svg .svg-pan-zoom_viewport").append(b);b=document.createElementNS("http://www.w3.org/2000/svg","g");b.setAttributeNS(null,"id","select_cart_g");$("#"+a+"_svg .svg-pan-zoom_viewport").append(b)}function createMapObject(a){createMapLayer(a)};